FROM ubuntu:18.04

# Set timezone:
RUN ln -snf /usr/share/zoneinfo/$CONTAINER_TIMEZONE /etc/localtime && echo $CONTAINER_TIMEZONE > /etc/timezone

#ARG SSH_PRIVATE_KEY
RUN apt-get update && apt-get install -y tzdata curl \
  && curl https://bootstrap.pypa.io/pip/3.5/get-pip.py -o get-pip.py \
  && apt-get install python3 python3-pip python3-setuptools -y \
  && python3 get-pip.py pip==20.3.4 \
  && apt-get install build-essential openssh-client git vim protobuf-compiler \
  libgl1-mesa-glx libglib2.0-0 libsm6 libxrender1 libxext6 -y
RUN pip3 install --no-cache --upgrade pip Pillow tensorflow-object-detection-api pandas
RUN ln -sf python3 /usr/bin/python
RUN curl -sL https://deb.nodesource.com/setup_16.x  | bash
RUN apt-get -yq install nodejs

RUN apt-get install linux-headers-$(uname -r)
  && distribution=$(. /etc/os-release;echo $ID$VERSION_ID | sed -e 's/\.//g')
  && wget https://developer.download.nvidia.com/compute/cuda/repos/$distribution/x86_64/cuda-$distribution.pin
  && mv cuda-$distribution.pin /etc/apt/preferences.d/cuda-repository-pin-600
  && apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/$distribution/x86_64/7fa2af80.pub
  && echo "deb http://developer.download.nvidia.com/compute/cuda/repos/$distribution/x86_64 /" | tee /etc/apt/sources.list.d/cuda.list
  && apt-get -y install cuda-drivers

WORKDIR /server

COPY . /server
RUN npm install -g npm
RUN npm install

VOLUME /demo_model_mms_helper_shared_volume
EXPOSE 3000
CMD [ "npm", "start" ]